# PPG用のスクリプト

ここではPPG用のスクリプトの内容およびその使い方について説明します。

**目次**

- [PPG用のスクリプト](#ppg用のスクリプト)
- [各スクリプトについて](#各スクリプトについて)
- [スクリプトの内容について](#スクリプトの内容について)
  - [auto\_simu\_gain](#auto_simu_gain)
    - [出力用の区切り線](#出力用の区切り線)
    - [スクリプトブロック](#スクリプトブロック)
    - [シミュレーションを実行する回数](#シミュレーションを実行する回数)
    - [シミュレーション結果を保存するファイル](#シミュレーション結果を保存するファイル)
    - [乱数の範囲](#乱数の範囲)
    - [タイムアウト時間(秒)](#タイムアウト時間秒)
    - [1. 乱数でパラメータを4つ生成](#1-乱数でパラメータを4つ生成)
    - [シミュレーション情報を表示/シミュレーション情報を simu\_result.txt に追記](#シミュレーション情報を表示シミュレーション情報を-simu_resulttxt-に追記)
    - [2. 生成したパラメータを gain.dat に保存](#2-生成したパラメータを-gaindat-に保存)
    - [3. matlab スクリプトを呼び出してシミュレーションを実行](#3-matlab-スクリプトを呼び出してシミュレーションを実行)
    - [4. シミュレーション結果を temp.log から取得し、垂直タブを削除して最後の20行を simu\_result.txt に追記](#4-シミュレーション結果を-templog-から取得し垂直タブを削除して最後の20行を-simu_resulttxt-に追記)
    - [効果音](#効果音)
  - [auto\_simu\_gain\_step](#auto_simu_gain_step)
  - [test\_case\_generator](#test_case_generator)
- [つかいかた](#つかいかた)
- [で、どうやってゲインを見つければええんや？](#でどうやってゲインを見つければええんや)
  - [ゲイン値の範囲について](#ゲイン値の範囲について)
    - [ゲイン値の役割と範囲のイメージ](#ゲイン値の役割と範囲のイメージ)
    - [ゲイン調整のポイント](#ゲイン調整のポイント)
    - [具体的な範囲の決定](#具体的な範囲の決定)



# 各スクリプトについて

* auto_simu_gain.ps1: パラメータをランダムで生成してシミュレーションを行います。説明通りのやつです。
* auto_simu_gain_step.ps1: パラメータを少しずつ変化させながらシミュレーションを行います。計算量のオーダーに注意。
* test_case_generator.ps1: 初期条件等をランダムで生成します。見つかったパラメータの対応力を試したいときに。

# スクリプトの内容について
## auto_simu_gain
プログラム中のいくつかの箇所について説明しておきます。

### 出力用の区切り線
記録ファイルでシミュレーションごとの区切りとして使う文字列です。とりあえずMATLABのシミュレーションの出力の幅に合わせてあります。

### スクリプトブロック
タイムアウトを実装するための都合上、並列で実行することにしました。

### シミュレーションを実行する回数
そのまま。クソでかい値にしておいて大学に居る間に自宅でシミュレーション…なんてこともできます。

### シミュレーション結果を保存するファイル
デフォルトではresultフォルダ内に保存するようにしています。末尾は日付を想定。

### 乱数の範囲
とりあえずPゲインとDゲインの両方について上限・下限を指定するようにしています。必要に応じて増やしてください。

### タイムアウト時間(秒)
シミュレーションに異常なほど時間がかかることがあったので実装してあります。というか時間がかかるようならそもそもパラメータとして優れてはいないので…。

### 1. 乱数でパラメータを4つ生成
「乱数の範囲」で指定した範囲のランダム値を生成し、パラメータに代入します。

ある値を中心に前後ここからここまで…みたいに指定することもできます。

### シミュレーション情報を表示/シミュレーション情報を simu_result.txt に追記
どの変数がどのゲインに対応しているかはここを見てください。

### 2. 生成したパラメータを gain.dat に保存
ここでMATLABに読み込ませる用のファイルを作成しています。

### 3. matlab スクリプトを呼び出してシミュレーションを実行
ここでMATLABを呼び出しています。

並列で実行している都合上、MATLABからの出力がリアルタイムでは表示されないことに注意。

### 4. シミュレーション結果を temp.log から取得し、垂直タブを削除して最後の20行を simu_result.txt に追記
「シミュレーション結果を保存するファイル」で指定したファイルに書き込みます。

保存する行数を変えたい人は`Select-Object -Last 20`の数値の部分をいじってください。

### 効果音
シミュレーションの完了をビープ音でお知らせします。不要ならコメントアウトしてください。


## auto_simu_gain_step
`auto_simu_gain`とほぼ変わりません。パラメータが乱数ではなくfor文で増えるようになっています。そこで上限や加減、刻み幅を指定してください。(Powershellは不等号とかの論理演算系の演算子が独特なんだよなぁ…)

コメントアウトを外せばDゲインも変化させられますが、シミュレーション回数が2乗のオーダーで増えることに注意してください。

## test_case_generator
見ればだいたいわかるとは思います。ちなみに表示される文字列はそのままコピペできるようにMATLABの形式に合わせてあります。

---

# つかいかた

1. Google Classroomで配布されたMATLABのファイルを`1_PPG`フォルダ内に全部突っ込みます。
2. `parameter.m`を、`parameter_PPG.m`を参考にして編集します。(ファイル名は`parameter.m`じゃないと読み込んでくれないのでいじらないこと)
3. ターミナルでこのフォルダを開き、Powershellで`.\auto_simu_gain.ps1`と入力して、Enterを押すことでシミュレーションが回ります。
4. 他のスクリプトを使うときも同様にファイルを直接指定して実行してください。

ちなみにウインドウの表示はoffにしておいたほうがいいですよ。

# で、どうやってゲインを見つければええんや？
とりあえずGoogleのGemini君に質問してみました。

---

ここからGeminiの出力(一部抜粋)

---

## ゲイン値の範囲について

**ゲイン値の適切な範囲は、システムの特性や制御目標によって大きく変動するため、一概に定めることはできません。**

### ゲイン値の役割と範囲のイメージ

* **Pゲイン:**
  * 比例ゲインであり、偏差（目標値と実際の値の差）に比例して制御出力を生成します。
  * Pゲインが大きいほど、応答は速くなりますが、振動が生じやすくなります。
  * 一般的には、システムの安定性を確保しつつ、応答速度を向上させるような範囲で調整されます。
  * 範囲は、システムの特性によって大きく異なりますが、0.1～100程度が一般的な範囲です。

* **Dゲイン:**
  * 微分ゲインであり、偏差の変化率に比例して制御出力を生成します。
  * Dゲインが大きいほど、振動を抑制できますが、応答が遅くなる傾向があります。
  * 一般的には、システムの振動を抑制しつつ、応答性を維持できるような範囲で調整されます。
  * 範囲は、Pゲインと同様にシステムの特性によって異なりますが、0～10程度が一般的な範囲です。

### ゲイン調整のポイント

* **シミュレーション:**
  * まずは、シミュレーション環境で様々なゲイン値を試して、システムの応答を確認することが重要です。
  * ステップ応答やランプ応答などの標準的な入力に対して、システムがどのように振る舞うかを観察します。
* **安定性:**
  * ゲイン値が大きすぎると、システムが不安定になり、発振してしまうことがあります。
  * 安定性を確保するために、ゲイン値の上限を注意深く設定する必要があります。
* **応答速度:**
  * ゲイン値を大きくすると、応答速度は向上しますが、振動が生じやすくなります。
  * 必要な応答速度と許容できる振動のバランスを考慮して、ゲイン値を調整します。
* **オーバーシュート:**
  * 目標値をオーバーして、その後目標値に落ち着く現象をオーバーシュートといいます。
  * オーバーシュートが大きすぎると、システムに悪影響を与える可能性があります。
  * オーバーシュートを抑制するために、Dゲインを調整します。

### 具体的な範囲の決定

**一般的な調整方法としては、以下の手順が考えられます。**

1. **Pゲインを徐々に増やしていく:** システムが安定している範囲で、Pゲインを少しずつ増やしていきます。
2. **Dゲインを調整する:** Pゲインを調整した後に、Dゲインを調整して振動を抑制します。

**注意:** ゲイン調整は、システムの特性や目的によって最適な方法が異なります。安易にゲイン値を変更すると、システムが不安定になる可能性があるため、十分に注意して行う必要があります。

---

ここまで

---

これを踏まえた上で考えてみましょう。

1. まずはDゲインを0で固定して、`auto_simu_gain_step`を実行する。
2. ゲインはクッソ大きな値にするとそもそもシミュレーションが完遂できなくなる。そこで、その辺をPゲインの上限と設定する。
3. `auto_simu_gain`を回してしばらく待つとそのうち最後まで完遂できるやつが現れるはずである。出なくても諦めるな。
4. うまくいくやつが現れたら、 Pゲインについてはその周辺を探索することにして、今度はDゲインに手を出す。これはクソデカ値にしなくて良い。
5. だいたいいい感じになったら初期条件を変えてまたやってみる。これはいろんなのを試すことを推奨する。特に、z固定でxyだけ変化させたものとxy固定でzだけ変化させたものについても試しておくこと(毎年必ず含まれるっぽい？)。

ちなみに自分はこの方法で全体のだいたい半分くらいの順位を取ることができました。
