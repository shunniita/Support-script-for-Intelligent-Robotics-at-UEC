# Practice
ここでは、MATLABでの入出力をどのように行い、そしてどのようにPowershellでMATLABを扱うのかについて解説する。

# 前提条件
課題のために配布されるファイルのほとんどは拡張子が`.p`となっており、編集不可能になっている。唯一改変可能なのが`parameter.m`であり、おそらく`main.p`の中の最初の方でこのファイルが読み込まれていると推測できる。

そしてどうやら読み込まれる際に**上から一行ずつ実行されている**みたいなのだ。

ということは…指定されたパラメータだけちゃんと代入してさえあればその前の段階でどれだけ計算が行われていようが…いや、(途中で強制終了させるみたいな無茶以外なら)何をしていようが許されるのである。

# 基本方針
とはいえ、MATLABの動作はそこそこ重くなるので、MATLAB側でやることはできるだけ少なくしておきたい。

どのみち何回も実行する羽目になるのだ(そしてそれは`parameter.m`の改変だけでは不可能)。ランダムな値を生成するのは外側で行い、それをMATLABに渡すことにする。

さて、MATLABはCLIで扱うこともできる。

[matlab (Windows)](https://jp.mathworks.com/help/matlab/ref/matlabwindows.html)

詳しくは上のURL先を参照してもらいたいのだが、要するに次のような形式でコマンドを入力すればいい。

```bash
$ matlab -batch "my_script"
```

となると標準入力を扱うことになりそうだ。

# inputを試す
まずは標準入力を読み取ってくれそうな[input](https://jp.mathworks.com/help/matlab/ref/input.html)関数を使ってみよう。

```matlab
x = input('');

disp(x)
```

入力をそのまま表示するだけのプログラムだ。このファイルを`stdin_test.m`として保存する。保存する場所は別にどこだっていいが、どうせなら余計なファイルが無い場所のほうが作業しやすいであろう。

GitHubからzipでダウンロードしているのであれば、この`0_practice`フォルダに`stdin_test.m`が入っている。

ダウンロードした`0_practice`フォルダを右クリックすれば「ターミナルで開く」という項目がどこかに現れるはずだ。そうすればPowershellでそのフォルダを開ける。試しに`ls`を実行してみよう。`stdin_test.m`が存在するとわかるはずだ。

あるいは画面下側にある検索バーから検索するなりしてターミナルを開いて、`cd`で地道に移動しても良い。

何を言ってるかわからんか？ならコンリテからやり直したまえ(まさか教科書を鍋敷きにしてたりしないだろうな？)。

> 実はUNIXのシェルで使うようなコマンドのうちいくつかはPowershellでも使えるのだ(おそらく既存のコマンドのエイリアスだとは思うが)。まぁ本格的にUNIXっぽくやりたいのならWSLに手を出すと良い。…MATLABってWSLで使えるのか？

---

いよいよ準備は整った。Powershellで`matlab -batch stdin_test`と入力してみると…

```
次を使用中のエラー: input
ユーザー入力のサポートが必要ですが、このプラットフォームでは使用できません。

エラー: stdin_test (行 1)
x = input('');
    ^^^^^^^^^

ERROR: MATLAB error Exit Status: 0x00000001
```

なんてこった。

# loadを試す
仕方がないので他の方法を探そう。今度は外部のファイルを読み込む関数を探すと…[load](https://jp.mathworks.com/help/matlab/ref/load.html)という関数があった。

説明を読んだところ、どうやら空白区切りで数値を書いておけば配列ないし行列が入力できるらしい。

とりあえず試してみよう。まずは`load_test.dat`として

```
11 12 13
21 22 23
31 32 33
```

というファイルを作り、次のようなプログラムを同じく`load_test.m`として保存する。

```matlab
%% load
data = load("load_test.dat","-ascii");

disp(data);

%% read
x = data(:,1);
y = data(:,2);
z = data(:,3);

disp(x);
disp(y);
disp(z);
```

> ここで、数値を書き込むファイルの拡張子を`.dat`としたのは単にデータ(data)を保存するファイルだからであって、メモ帳で開けないような特別な形式だったりするわけではない。別に`.txt`のままでも良い。何なら他のでもいい。ただ、`.mat`とするとちょっと話がめんどくさくなるぞ。やめておこう。

それでは試してみよう。`matlab -batch load_test`として…
```
    11    12    13
    21    22    23
    31    32    33

    11
    21
    31

    12
    22
    32

    13
    23
    33

```

やったぜ。

暇があったら`load_test.dat`の中身を書き換えてみて、表示がその通りに変わるかどうか試してみよう。

# ログを取る
さて、MATLABの出力結果もまたターミナルに表示されるわけだが、その内容を毎回手作業でコピペするのも面倒だ。せっかくなら記録も自動化しておきたい。幸い、MATLAB側でオプションが用意されている。`matlab -batch load_test -logfile "load_test.log"`を実行してみよう。

実行したか？おそらく`load_test.log`というファイルが出現しているはずだ。それを見ると確かにターミナルで表示されていた内容が書き込まれている。

> ここで拡張子を`.log`にしたのもやはりログ(log)を保存するファイルだからであって…以下略。

ところが、`load_test.dat`の中身を書き換えてみて再び実行すると、なんと`load_test.log`の内容が変わっている。

そう。実はこの方法だとログファイルが毎回新規に作成されてしまうのだ。

では毎回別のファイル名にすれば良いのか？そんなことをしたらシミュレーション回数分だけのファイルができてフォルダ内がログファイルで溢れてしまうぞ。せっかく楽に記録を取ろうと思ったのにこれでは逆効果だ。

ネタバレになってしまうが、実はシミュレーションがうまく行ったのかどうか、うまく行ったときはどれくらいのスコアだったのかについては、ログファイルの最後の数十行だけ見ればわかる。つまり、そこだけを集めてしまえば良いのだ。

# 結論
というわけで、こんな感じのPowershellスクリプトを作ることにしよう。

1. ランダムな値を必要な分だけ生成
2. 生成した数を書き込んだファイルを作成
3. MATLABを呼び出す
   1. あらかじめ`parameter.m`で外部ファイルからパラメータを読み取るように改変しておく
   2. MATLABの`main`内で`parameter.m`が読み込まれ、そこで生成した値がパラメータに代入され、シミュレーションが回る
   3. 結果をログ用のファイルに書き込むようにしておく
4. ログファイルの最後のn行を読み取り、記録用ファイルの末尾に追記する。
5.  1～4を、いい感じの結果が出るまで繰り返す。

---

そして出来上がったスクリプトが`1_PPG`と`2_F16`に入っている。実際のところはこの解説のように進んだのではなく、ChatGPTたちに質問しながら試行錯誤と増改築を繰り返してきたのだが。その完成形を一から説明するとこうなる。

UNIX系でシェルスクリプトでやりたい人にも参考になっただろうか…？
